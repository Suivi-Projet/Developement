<div class="row-fluid">
    <div class="span2 offset5">
        <h4>Projet :</h4>
        <select class="form-control" id="selectProjet" onChange="majTaches();majEtatProj();majRecapProj(); majRecapTaches();"></select>
    </div>
</div>
<div class="row-fluid">
    <div class="span4">
        <fieldset>
            <legend>Rappel Projet</legend>
            <table class="table table-bordered table-hover">

                <tbody>
                    <tr >
                        <td class="btn-primary disabled col-md-2">nombre de tâches</td>
                        <td class="col-md-1" id="nbTask"></td>
                        <td class="col-md-1"></td>
                    </tr>
                    <tr >
                        <td class="btn-primary disabled col-md-2">dépassements de charges</td>
                        <td class="col-md-1" id="upperThanInitial"></td>
                        <td class="col-md-1" id="percentUpper"></td>
                    </tr>
                    <tr>
                        <td class="btn-primary disabled col-md-2" >retards</td>
                        <td class="col-md-1" id="late"></td>
                        <td class="col-md-1" id="percentLate"></td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
    </div>
    <div class="span8">
        <fieldset>
            <legend>Etat Projet</legend>
            <table class="table table-bordered table-hover">
                <thead >
                    <tr>
                        <td class="col-md-2"></td>
                        <td class="col-md-2 btn-primary disabled">prévu</td>
                        <td class="col-md-2 btn-primary disabled">réel</td>
                        <td class="col-md-2 btn-primary disabled">Ecarts</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="btn-primary disabled">début</td>
                        <td id="debutPrevu"></td>
                        <td id="debutReel"></td>
                        <td id="ecartDebut"></td>
                    </tr>
                    <tr>
                        <td class="btn-primary disabled">fin</td>
                        <td id="finPrevu"></td>
                        <td id="finReel"></td>
                        <td id="ecartFin"></td>
                    </tr>
                    <tr>
                        <td class="btn-primary disabled">durée (h)</td>
                        <td id="dureePrevue"></td>
                        <td id="dureeReelle"></td>
                        <td id="ecartDuree"></td>
                    </tr>
                    <tr>
                        <td class="btn-primary disabled">montant (€)</td>
                        <td id="montantPrevue"></td>
                        <td id="montantReelle"></td>
                        <td id="ecartMontant"></td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
    </div>
</div>
<div class="row-fluid">
    <div class="span12">
        <fieldset>
            <legend>Récapitulatif des tâches</legend>
            <table class="table table-bordered table-hover">
                <thead class="btn-primary disabled">
                    <tr>
                        <td>Réf. Tâche</td>
                        <td>Libellé</td>
                        <td>Début Réel</td>
                        <td>Fin Réelle</td>
                        <td>Temps Consommé</td>
                        <td>Coût</td>
                        <td>Ratio tps réel / tps prévu</td>
                        <td>% avancement</td>
                        <td>Temps restant estimé</td>
                        <td>Respect de la charge</td>
                        <td>Retard avéré</td>
                    </tr>
                </thead>
                <tbody id="recapTaches">
                </tbody>
            </table>
        </fieldset>
    </div>
</div>
<div><button class="btn btn-primary" id="callFormSaisie" data-toggle="modal" data-target="#form-saisie">Saisie</button></div>

<div class="modal fade" id="form-saisie" tabindex="-1" role="dialog"
     aria-labelledby="labelSaisie" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="labelSaisie">
                    Ajouter une ressource
                </h4>
            </div>
            <div class="modal-body" id="addFormSaisie">
                <form class="form-horizontal">
                    <div class="row-fluid">
                        <div class="form-group">
                            <div class="col-md-12">
                                <label class="control-label" for="Nom">Nom</label>
                                <select class="form-control" id="selectRessource"></select>
                                <label class="control-label" for="referenceTache">Tâche avancée</label>
                                <select class="form-control" id="selectTache"></select>
                                <label class="control-label" for="tpsPasse">Temps passé sur la tâche (h)</label>
                                <input class="form-control" type="number" id="tpsPasseTache" min="0">
                                <label class="control-label" for="tpsPasse">Pourcentage avancement tâche (%)</label>
                                <input class="form-control" type="number" id="pourcentTache" min="0">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">
                    Cancel
                </button>
                <button type="button" id="addSaisie" class="btn btn-primary">
                    Ajouter
                </button>
            </div>
        </div>
    </div>
</div>
<script>
	$(function() {
        var dialogSaisie, formSaisie,

		tpsPasse = $( "#tpsPasseTache" ),
        pctTache = $("#pourcentTache"),
        allFields = $( [] ).add(tpsPasse).add(pctTache),
        tips = $( ".validateTips" );

        function updateTips( t ) {
            tips
				.text( t )
				.addClass( "ui-state-highlight" );
            setTimeout(function() {
                tips.removeClass( "ui-state-highlight", 1500 );
            }, 500 );
        }

        function checkLength( o, n, min, max ) {
            if ( o.val().length > max || o.val().length < min ) {
                o.addClass( "ui-state-error" );
                updateTips( "Length of " + n + " must be between " +
                        min + " and " + max + "." );
                return false;
            } else {
                return true;
            }
        }

        function addSaisie() {
            var valid = true;
            allFields.removeClass( "ui-state-error" );

            valid = valid && checkLength( tpsPasse, "tempsPasse", 1, 10 ) && checkLength(pctTache, "pourcentTache", 1, 3) && pctTache.val() >= 0 && pctTache.val() <= 100;

            if ( valid ) {
            	var data = '{"codeRessource" : "' + $("#selectRessource").val() + '", "codeTache" : "' + $("#selectTache").val() + '", "tempsPassee" : "' + $("#tpsPasseTache").val() + '", "avancement" : "' + $("#pourcentTache").val() + '"}';
                $.ajax({
					type: "POST",
					url: "http://localhost/Developement/queries/suivi.php",
					dataType: 'json',
					contentType:'application/json',
					data: data,
					success : function(){
						majTaches();
                        majRecapProj();
                        majEtatProj();
                        majRecapTaches();
                        $('#form-saisie').modal('hide');;
                    },
                    error : function(){
                        alert("Y'a un souci");
                        $('#form-saisie').modal('hide');
                    }
				});
            }
            return valid;
        }
        $( "#addSaisie" ).button().on( "click", function() {
            addSaisie();
        });

        $("#callFormSaisie").on("click", function(){
            $('#addFormSaisie').find('select').val('');
            $('#tpsPasseTache').val('');
            $('#pourcentTache').val('');
        });
    });
</script>
<script>
	function majProjets(){
		$("#selectProjet").empty();

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProjet").append("<option value='" + currentValue.codeProjet + "'>" + currentValue.libelleProjet + "</option>");
			});
			$.getJSON("http://localhost/Developement/queries/parametres.php?objet=ressources", function(data){
				if(jQuery.parseJSON(data.data) !== false)
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					$("#selectRessource").append("<option value='" + currentValue.codeRessource + "'>" + currentValue.nomRessource + "</option>");
				});
                majTaches();
                majRecapProj();
                majEtatProj();
                majRecapTaches();
			});
		});
	}

	majProjets();

	function majTaches(){
		$("#selectTache").empty();

		$.getJSON("http://localhost/Developement/queries/previsionnel.php?idProjet=" + $("#selectProjet").val(), function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectTache").append("<option value='" + currentValue.codeTache + "'>" + currentValue.libelleTache + "</option>");
			});
		});
	}

    function majRecapProj(){
        $("#nbTask").empty();
        $("#upperThanInitial").empty();
        $("#percentUpper").empty();
        $("#late").empty();
        $("#percentLate").empty();

        $.getJSON("http://localhost/Developement/queries/suivi.php?idProjet=" + $("#selectProjet").val(), function(data){
            if(jQuery.parseJSON(data.data) !== false) {
                $("#nbTask").append(jQuery.parseJSON(data.data).nbTaches);
                $("#upperThanInitial").append(jQuery.parseJSON(data.data).nbDepassement);
                $("#late").append(jQuery.parseJSON(data.data).nbLate);
                $("#percentUpper").append(parseFloat((jQuery.parseJSON(data.data).nbDepassement / jQuery.parseJSON(data.data).nbTaches * 100)).toFixed(2) + "%");
                $("#percentLate").append(parseFloat((jQuery.parseJSON(data.data).nbLate / jQuery.parseJSON(data.data).nbTaches * 100)).toFixed(2) + "%");
            }
        });
    }

    function majEtatProj(){
        $("#debutPrevu").empty();
        $("#debutReel").empty();
        $("#ecartDebut").empty();
        $("#finPrevu").empty();
        $("#finReel").empty();
        $("#ecartFin").empty();
        $("#dureePrevue").empty();
        $("#dureeReelle").empty();
        $("#ecartDuree").empty();
        $("#montantPrevue").empty();
        $("#montantReelle").empty();
        $("#ecartMontant").empty();


        var months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

        $.getJSON("http://localhost/Developement/queries/suivi.php?infoProjet=" + $("#selectProjet").val(), function(data){
            if(jQuery.parseJSON(data.data) !== false) {

                if (jQuery.parseJSON(data.data).dateDebutPrevue != null) {
                    var dateDebutPrevu = new Date(jQuery.parseJSON(data.data).dateDebutPrevue).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateDebutPrevue).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateDebutPrevue).getFullYear();
                    $("#debutPrevu").append(dateDebutPrevu);
                }

                if (jQuery.parseJSON(data.data).dateFinPrevue != null) {
                    var dateFinPrevu = new Date(jQuery.parseJSON(data.data).dateFinPrevue).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateFinPrevue).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateFinPrevue).getFullYear();
                    $("#finPrevu").append(dateFinPrevu);
                }

                if (jQuery.parseJSON(data.data).dureePrevu != null) {
                    $("#dureePrevue").append(jQuery.parseJSON(data.data).dureePrevu);
                }

                if (jQuery.parseJSON(data.data).montantPrevu != null) {
                    $("#montantPrevue").append(jQuery.parseJSON(data.data).montantPrevu);
                }

                if (jQuery.parseJSON(data.data).dateDebutReelle != null) {
                    var dateDebutReel = new Date(jQuery.parseJSON(data.data).dateDebutReelle).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateDebutReelle).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateDebutReelle).getFullYear();
                    $("#debutReel").append(dateDebutReel);
                }

                if (jQuery.parseJSON(data.data).dateFinReelle != null) {
                    var dateFinReel = new Date(jQuery.parseJSON(data.data).dateFinReelle).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateFinReelle).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateFinReelle).getFullYear();
                    $("#finReel").append(dateFinReel);
                }

                if (jQuery.parseJSON(data.data).tempsConsomme != null) {
                    $("#dureeReelle").append(jQuery.parseJSON(data.data).tempsConsomme);
                }

                if (jQuery.parseJSON(data.data).montantReel != null) {
                    $("#montantReelle").append(jQuery.parseJSON(data.data).montantReel);
                }

                if (jQuery.parseJSON(data.data).ecartDateDebut != null) {
                    $("#ecartDebut").append(jQuery.parseJSON(data.data).ecartDateDebut);
                }

                if (jQuery.parseJSON(data.data).ecartDateFin != null) {
                    $("#ecartFin").append(jQuery.parseJSON(data.data).ecartDateFin);
                }

                if (jQuery.parseJSON(data.data).ecartDuree != null) {
                    $("#ecartDuree").append(jQuery.parseJSON(data.data).ecartDuree);
                }

                if (jQuery.parseJSON(data.data).ecartMontant != null) {
                    $("#ecartMontant").append(jQuery.parseJSON(data.data).ecartMontant);
                }
            }
        });
    }

    function majRecapTaches(){
        $("#recapTaches").empty();

        $.getJSON("http://localhost/Developement/queries/suivi.php?recapProjet=" + $("#selectProjet").val(), function(data){
            jQuery.parseJSON(data.data).forEach(function(currentValue) {
                var dateDebutReelle = currentValue.dateDebutReelle == null ? "/" : currentValue.dateDebutReelle;
                var dateFinReelle = currentValue.dateFinReelle == null ? "/" : currentValue.dateFinReelle;
                var dateJour = new Date();
                var couleurCharge = "#B6F576";
                var couleurRetard = "#F57676";

                if (dateJour.addDays(parseInt(currentValue.tempsRestant / currentValue.dureeLegale)) > currentValue.dateFinPrevue || (currentValue.dateFinPrevu < dateJour) && currentValue.dateFinReelle == null) {
                    couleurRetard = "#F57676";
                } else {
                    couleurRetard = "#B6F576";
                }

                if (currentValue.tempsConsomme > currentValue.tempsPrevu) {
                    couleurCharge = "#F57676";
                } else {
                    couleurCharge = "#B6F576";
                }

                var tempsConsomme = currentValue.tempsConsomme == null ? "0" : currentValue.tempsConsomme;
                var cout = currentValue.cout == null ? "0" : currentValue.cout;
                var ratioTemps = currentValue.ratioTemps == null ? "0" : currentValue.ratioTemps;

                var tempsRestant = currentValue.tempsPrevu;

                if (currentValue.avancement != 0) {
                    if (tempsConsomme != "0"){
                        tempsRestant = ((tempsConsomme * 100) / currentValue.avancement);
                    }
                }

                $("#recapTaches").append("<tr><td>" + currentValue.referenceTache + "</td><td>" + currentValue.libelleTache + "</td><td>" + dateDebutReelle + "</td><td>" + dateFinReelle + "</td><td>" + tempsConsomme + "</td><td>" + cout + "</td><td>" + parseFloat(ratioTemps).toFixed(2) + "</td><td> <div class='progress'><div class='progress-bar progress-bar-info progress-bar-striped' role='progressbar'  aria-valuemin='0' aria-valuemax='100' style='width: "+ currentValue.avancement +"%;'>"+ currentValue.avancement +" %</div></div></td><td>" + tempsRestant + "</td><td style='background-color: " + couleurCharge + ";'></td><td style='background-color: " + couleurRetard + ";'></td></tr>");
            });
        });
    }

    Date.prototype.addDays = function(days)
    {
        var dat = new Date(this.valueOf());
        dat.setDate(dat.getDate() + days);
        return dat;
    }
</script>