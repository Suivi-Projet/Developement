<div>
	<div><label for="projet">Projet :</label>
	<select id="selectProjet" onChange="majTaches();majEtatProj();majRecapProj();majRecapTaches();">
	</select></div>
    <div>
        <div>
            <fieldset>
                <legend>Rappel Projet</legend>
                <table>
                    <tbody>
                        <tr>
                            <td>nombre de tâches</td>
                            <td id="nbTask"></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>dépassements de charges</td>
                            <td id="upperThanInitial"></td>
                            <td id="percentUpper"></td>
                        </tr>
                        <tr>
                            <td>retards</td>
                            <td id="late">7</td>
                            <td id="percentLate"></td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>
        </div>
        <div>
            <fieldset>
                <legend>Etat Projet</legend>
                <table>
                    <thead>
                        <tr>
                            <td></td>
                            <td>prévu</td>
                            <td>réel</td>
                            <td>Ecarts</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>début</td>
                            <td id="debutPrevu">25 Mai 2016</td>
                            <td id="debutReel">06 Juin 2016</td>
                            <td id="ecartDebut">15</td>
                        </tr>
                        <tr>
                            <td>fin</td>
                            <td id="finPrevu">29 Mai 2016</td>
                            <td id="finReel">10 Juin 2016</td>
                            <td id="ecartFin">15</td>
                        </tr>
                        <tr>
                            <td>durée (h)</td>
                            <td id="dureePrevue">4</td>
                            <td id="dureeReelle">4</td>
                            <td id="ecartDuree">0</td>
                        </tr>
                        <tr>
                            <td>montant (€)</td>
                            <td id="montantPrevue">150</td>
                            <td id="montantReelle">160</td>
                            <td id="ecartMontant">10</td>
                        </tr>
                    </tbody>
                </table>
            </fieldset>
        </div>
        <div>
            <fieldset>
                <legend>Récapitulatif des tâches</legend>
                <table>
                    <thead>
                        <tr>
                            <td>Réf. Tâche</td>
                            <td>Libellé</td>
                            <td>Début Réel</td>
                            <td>Fin Réelle</td>
                            <td>Temps Consommé</td>
                            <td>Coût</td>
                            <td>Ratio tps réel / tps prévu</td>
                            <td>% avancement</td>
                            <td>Temps restant estimé</td>
                            <td>Respect de la charge</td>
                            <td>Retard avéré</td>
                        </tr>
                    </thead>
                    <tbody id="recapTaches">
                    </tbody>
                </table>
            </fieldset>
        </div>
    </div>
	<div><button id="addSaisie">Saisie</button></div>
</div>
<div id="dialog-form-saisie" title="Saisir un temps de travail">
    <form>
    	<div><label for="nom">Membre du personnel</label>
    	<select id="selectRessource"></select></div>
        <div><label for="referenceTache">Tâche avancée</label>
    	<select id="selectTache"></select></div>
        <div><label for="tpsPasse">Temps passé sur la tâche (h)</label>
        <input type="number" id="tpsPasseTache"></div>
        <div><label for="tpsPasse">Pourcentage avancement tâche (%)</label>
        <input type="number" id="pourcentTache"></div>
    </form>
</div>
<script>
	$(function() {
        var dialogSaisie, formSaisie,

		tpsPasse = $( "#tpsPasseTache" ),
        pctTache = $("#pourcentTache"),
        allFields = $( [] ).add(tpsPasse).add(pctTache),
        tips = $( ".validateTips" );

        function updateTips( t ) {
            tips
				.text( t )
				.addClass( "ui-state-highlight" );
            setTimeout(function() {
                tips.removeClass( "ui-state-highlight", 1500 );
            }, 500 );
        }

        function checkLength( o, n, min, max ) {
            if ( o.val().length > max || o.val().length < min ) {
                o.addClass( "ui-state-error" );
                updateTips( "Length of " + n + " must be between " +
                        min + " and " + max + "." );
                return false;
            } else {
                return true;
            }
        }

        function addSaisie() {
            var valid = true;
            allFields.removeClass( "ui-state-error" );

            valid = valid && checkLength( tpsPasse, "tempsPasse", 1, 10 ) && checkLength(pctTache, "pourcentTache", 1, 3) && pctTache.val() >= 0 && pctTache.val() <= 100;

            if ( valid ) {
            	$.ajax({
					type: "POST",
					url: "http://localhost/Developement/queries/suivi.php",
					dataType: 'json',
					contentType:'application/json',
					data: '{"codeRessource" : "' + $("#selectRessource").val() + '", "codeTache" : "' + $("#selectTache").val() + '", "tempsPassee" : "' + $("#tpsPasseTache").val() + '", "avancement" : "' + $("#pourcentTache").val() + '"}',
					success : function(){
						majTaches();
                        majRecapProj();
                        majEtatProj();
                        majRecapProj();
						dialogSaisie.dialog("close");
					},
					error : function(){
						alert("Y'a un souci")
						dialogSaisie.dialog("close");
					}
				});
            }
            return valid;
        }

        dialogSaisie = $( "#dialog-form-saisie" ).dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Ajouter": addSaisie,
                Cancel: function() {
                    dialogSaisie.dialog( "close" );
                }
            },
            close: function() {
                formSaisie[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
            }
        });

        formSaisie = dialogSaisie.find( "form" ).on( "submit", function( event ) {
            event.preventDefault();
            addSaisie();
        });

        $( "#addSaisie" ).button().on( "click", function() {
            dialogSaisie.dialog( "open" );
        });
    });
</script>
<script>
	function majProjets(){
		$("#selectProjet").empty();

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProjet").append("<option value='" + currentValue.codeProjet + "'>" + currentValue.libelleProjet + "</option>");
			});
			$.getJSON("http://localhost/Developement/queries/parametres.php?objet=ressources", function(data){
				if(jQuery.parseJSON(data.data) !== false)
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					$("#selectRessource").append("<option value='" + currentValue.codeRessource + "'>" + currentValue.nomRessource + "</option>");
				});
                majTaches();
                majRecapProj();
                majEtatProj();
                majRecapTaches();
			});
		});
	}

	majProjets();

	function majTaches(){
		$("#selectTache").empty();

		$.getJSON("http://localhost/Developement/queries/previsionnel.php?idProjet=" + $("#selectProjet").val(), function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectTache").append("<option value='" + currentValue.codeTache + "'>" + currentValue.libelleTache + "</option>");
			});
		});
	}

    function majRecapProj(){
        $("#nbTask").empty();
        $("#upperThanInitial").empty();
        $("#percentUpper").empty();
        $("#late").empty();
        $("#percentLate").empty();

        $.getJSON("http://localhost/Developement/queries/suivi.php?idProjet=" + $("#selectProjet").val(), function(data){
            if(jQuery.parseJSON(data.data) !== false) {
                $("#nbTask").append(jQuery.parseJSON(data.data).nbTaches);
                $("#upperThanInitial").append(jQuery.parseJSON(data.data).nbDepassement);
                $("#late").append(jQuery.parseJSON(data.data).nbLate);
                $("#percentUpper").append(parseFloat((jQuery.parseJSON(data.data).nbDepassement / jQuery.parseJSON(data.data).nbTaches * 100)).toFixed(2) + "%");
                $("#percentLate").append(parseFloat((jQuery.parseJSON(data.data).nbLate / jQuery.parseJSON(data.data).nbTaches * 100)).toFixed(2) + "%");
            }
        });
    }

    function majEtatProj(){
        $("#debutPrevu").empty();
        $("#debutReel").empty();
        $("#ecartDebut").empty();
        $("#finPrevu").empty();
        $("#finReel").empty();
        $("#ecartFin").empty();
        $("#dureePrevue").empty();
        $("#dureeReelle").empty();
        $("#ecartDuree").empty();
        $("#montantPrevue").empty();
        $("#montantReelle").empty();
        $("#ecartMontant").empty();


        var months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

        $.getJSON("http://localhost/Developement/queries/suivi.php?infoProjet=" + $("#selectProjet").val(), function(data){
            if(jQuery.parseJSON(data.data) !== false) {

                if (jQuery.parseJSON(data.data).dateDebutPrevue != null) {
                    var dateDebutPrevu = new Date(jQuery.parseJSON(data.data).dateDebutPrevue).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateDebutPrevue).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateDebutPrevue).getFullYear();
                    $("#debutPrevu").append(dateDebutPrevu);
                }

                if (jQuery.parseJSON(data.data).dateFinPrevue != null) {
                    var dateFinPrevu = new Date(jQuery.parseJSON(data.data).dateFinPrevue).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateFinPrevue).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateFinPrevue).getFullYear();
                    $("#finPrevu").append(dateFinPrevu);
                }

                if (jQuery.parseJSON(data.data).dureePrevu != null) {
                    $("#dureePrevue").append(jQuery.parseJSON(data.data).dureePrevu);
                }

                if (jQuery.parseJSON(data.data).montantPrevu != null) {
                    $("#montantPrevue").append(jQuery.parseJSON(data.data).montantPrevu);
                }

                if (jQuery.parseJSON(data.data).dateDebutReelle != null) {
                    var dateDebutReel = new Date(jQuery.parseJSON(data.data).dateDebutReelle).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateDebutReelle).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateDebutReelle).getFullYear();
                    $("#debutReel").append(dateDebutReel);
                }

                if (jQuery.parseJSON(data.data).dateFinReelle != null) {
                    var dateFinReel = new Date(jQuery.parseJSON(data.data).dateFinReelle).getDate() + " " + months[new Date(jQuery.parseJSON(data.data).dateFinReelle).getMonth()] + " " + new Date(jQuery.parseJSON(data.data).dateFinReelle).getFullYear();
                    $("#finReel").append(dateFinReel);
                }

                if (jQuery.parseJSON(data.data).tempsConsomme != null) {
                    $("#dureeReelle").append(jQuery.parseJSON(data.data).tempsConsomme);
                }

                if (jQuery.parseJSON(data.data).montantReel != null) {
                    $("#montantReelle").append(jQuery.parseJSON(data.data).montantReel);
                }

                if (jQuery.parseJSON(data.data).ecartDateDebut != null) {
                    $("#ecartDebut").append(jQuery.parseJSON(data.data).ecartDateDebut);
                }

                if (jQuery.parseJSON(data.data).ecartDateFin != null) {
                    $("#ecartFin").append(jQuery.parseJSON(data.data).ecartDateFin);
                }

                if (jQuery.parseJSON(data.data).ecartDuree != null) {
                    $("#ecartDuree").append(jQuery.parseJSON(data.data).ecartDuree);
                }

                if (jQuery.parseJSON(data.data).ecartMontant != null) {
                    $("#ecartMontant").append(jQuery.parseJSON(data.data).ecartMontant);
                }
            }
        });
    }

    function majRecapTaches(){
        $("#recapTaches").empty();

        $.getJSON("http://localhost/Developement/queries/suivi.php?recapProjet=" + $("#selectProjet").val(), function(data){
            jQuery.parseJSON(data.data).forEach(function(currentValue) {
                var dateDebutReelle = currentValue.dateDebutReelle == null ? "/" : currentValue.dateDebutReelle;
                var dateFinReelle = currentValue.dateFinReelle == null ? "/" : currentValue.dateFinReelle;
                var dateJour = new Date();
                var couleurCharge = "green";
                var couleurRetard = "red";

                if (dateJour.addDays(parseInt(currentValue.tempsRestant / currentValue.dureeLegale)) > currentValue.dateFinPrevue || (currentValue.dateFinPrevu < dateJour) && currentValue.dateFinReelle == null) {
                    couleurRetard = "red";
                } else {
                    couleurRetard = "green";
                }

                if (currentValue.tempsConsomme > currentValue.tempsPrevu) {
                    couleurCharge = "red";
                } else {
                    couleurCharge = "green";
                }

                var tempsConsomme = currentValue.tempsConsomme == null ? "0" : currentValue.tempsConsomme;
                var cout = currentValue.cout == null ? "0" : currentValue.cout;
                var ratioTemps = currentValue.ratioTemps == null ? "0" : currentValue.ratioTemps;

                var tempsRestant = currentValue.tempsPrevu;

                if (currentValue.avancement != 0) {
                    if (tempsConsomme != "0"){
                        tempsRestant = ((tempsConsomme * 100) / currentValue.avancement);
                    }
                }

                $("#recapTaches").append("<tr><td>" + currentValue.referenceTache + "</td><td>" + currentValue.libelleTache + "</td><td>" + dateDebutReelle + "</td><td>" + dateFinReelle + "</td><td>" + tempsConsomme + "</td><td>" + cout + "</td><td>" + parseFloat(ratioTemps).toFixed(2) + "</td><td>" + currentValue.avancement + "</td><td>" + tempsRestant + "</td><td style=\"background-color:" + couleurCharge + ";\"></td><td style=\"background-color:" + couleurRetard + "\"></td></tr>");
            });
        });
    }

    Date.prototype.addDays = function(days)
    {
        var dat = new Date(this.valueOf());
        dat.setDate(dat.getDate() + days);
        return dat;
    }
</script>