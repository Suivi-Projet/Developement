<div class="row-fluid">
	<div class="span2 offset5">
		<h4>Projet :</h4>
		<select class="form-control" id="selectProjectDC" onChange="majSelectedDC();"></select>
	</div>
</div>
<div class="row-fluid">
	<div class="span5">
		<div class="x_panel">
			<div class="x_title"><h4>Total temps famille</h4></div>
			<div class="x_content">
				<canvas id="canvasDoughnut"></canvas>
			</div>
		</div>
	</div>
</div>

<script src="vendors/nprogress/nprogress.js"></script>
<script src="vendors/Chart.js/dist/Chart.min.js"></script>

<script>

	function majProjetsDC(){
		$("#selectProjectDC").empty();

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProjectDC").append("<option value='" + currentValue.codeProjet + "'>" + currentValue.libelleProjet + "</option>");
			});
	        $.ajax({
	            type: "GET",
	            url: "http://localhost/Developement/queries/maj_session.php?projetEnCours=bite",
	            success : function(data){
	                $("#selectProjectDC").val(jQuery.parseJSON(data).data);
            		fillDonut();
	            }
	        });
		});
	}

    function majSelectedDC(){
        $.ajax({
            type: "POST",
            url: "http://localhost/Developement/queries/maj_session.php",
            data: {
                projetEnCours: $("#selectProjectDC").val()
            },
            success: function(){
            	fillDonut();
            }
        });
    }

	majProjetsDC();

	function fillDonut(){
		$("#canvasDoughnut").empty();
		var ctx = document.getElementById("canvasDoughnut");
		var canvasDoughnut;
		var dataDonut = {
			labels: [],
			datasets: [{
				data: [],
				backgroundColor: [
					"#455C73",
					"#9B59B6",
					"#BDC3C7",
					"#26B99A",
					"#3498DB"
				],
				hoverBackgroundColor: [
					"#34495E",
					"#B370CF",
					"#CFD4D8",
					"#36CAAB",
					"#49A9EA"
				]
			}]
		};

		$.getJSON("http://localhost/Developement/queries/donnees_croisees.php?famTpsTotal=" + $("#selectProjectDC").val(), function(data){
			if (jQuery.parseJSON(data.data) !== false) {
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					var nomFam = currentValue.libellefamille;
					var tpsTotal = currentValue.tmpsTotal;
					dataDonut.labels.push(nomFam);
					dataDonut.datasets[0].data.push(tpsTotal);
				});
			}
			canvasDoughnut = new Chart(ctx, {
				type: 'doughnut',
				tooltipFillColor: "rgba(51, 51, 51, 0.55)",
				data: dataDonut
			});
		});


	}
</script>