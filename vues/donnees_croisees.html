<div class="row-fluid">
	<div class="span2 offset5">
		<h4>Projet :</h4>
		<select class="form-control" id="selectProjectDC" onChange="majSelectedDC();"></select>
	</div>
</div>
<div></div>
<div class="row-fluid">
	<div class="col-md-3 col-lg-3 col-sm-3">
		<div class="x_panel">
			<div class="x_title"><h4>Total temps par famille</h4></div>
			<div class="clearfix"></div>
			<div class="x_content">
				<canvas id="famDonut"></canvas>
			</div>
		</div>
	</div>
	<div class="col-md-3 col-lg-3 col-sm-3">
		<div class="x_panel">
			<div class="x_title"><h4>Total temps par livrable</h4></div>
			<div class="clearfix"></div>
			<div class="x_content">
				<canvas id="livDonut"></canvas>
			</div>
		</div>
	</div>
	<div class="col-md-3 col-lg-3 col-sm-3">
		<div class="x_panel">
			<div class="x_title"><h4>Total temps par ressource</h4></div>
			<div class="clearfix"></div>
			<div class="x_content">
				<canvas id="resDonut"></canvas>
			</div>
		</div>
	</div>
	<div class="col-md-3 col-lg-3 col-sm-3">
		<div class="x_panel">
			<div class="x_title"><h4>Total temps par tâche</h4></div>
			<div class="clearfix"></div>
			<div class="x_content">
				<canvas id="tacheDonut"></canvas>
			</div>
		</div>
	</div>
</div>
<div class="row-fluid">

	<div class="span8 offset2">
		<div class="x_panel">
			<div class="x_title"><h4>Coût ressource par mois</h4></div>
			<div class="clearfix"></div>
			<div class="x_content">
				<canvas id="tpsResGraph"></canvas>
			</div>
		</div>
	</div>
</div>

<script src="vendors/nprogress/nprogress.js"></script>
<script src="vendors/Chart.js/dist/Chart.min.js"></script>

<script>

	function majProjetsDC(){
		$("#selectProjectDC").empty();

		$.getJSON("http://localhost/developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProjectDC").append("<option value='" + currentValue.codeProjet + "'>" + currentValue.libelleProjet + "</option>");
			});
	        $.ajax({
	            type: "GET",
	            url: "http://localhost/developement/queries/maj_session.php?projetEnCours=bite",
	            success : function(data){
	                $("#selectProjectDC").val(jQuery.parseJSON(data).data);
            		fillFamDonut();
					fillLivDonut();
					fillResDonut();
					fillTacheDonut();
					fillTpsResGraph();
	            }
	        });
		});
	}

    function majSelectedDC(){
        $.ajax({
            type: "POST",
            url: "http://localhost/developement/queries/maj_session.php",
            data: {
                projetEnCours: $("#selectProjectDC").val()
            },
            success: function(){
            	fillFamDonut();
				fillLivDonut();
				fillResDonut();
				fillTacheDonut();
				fillTpsResGraph();
            }
        });
    }

	majProjetsDC();

	function fillFamDonut(){
		$("#famDonut").empty();
		var ctx = document.getElementById("famDonut");
		var famDonut;
		var dataDonut = {
			labels: [],
			datasets: [{
				data: [],
				backgroundColor: [
					"#455C73",
					"#9B59B6",
					"#BDC3C7",
					"#26B99A",
					"#3498DB"
				],
				hoverBackgroundColor: [
					"#34495E",
					"#B370CF",
					"#CFD4D8",
					"#36CAAB",
					"#49A9EA"
				]
			}]
		};

		$.getJSON("http://localhost/developement/queries/donnees_croisees.php?famTpsTotal=" + $("#selectProjectDC").val(), function(data){
			if (jQuery.parseJSON(data.data) !== false) {
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					var nomFam = currentValue.libellefamille;
					var tpsTotal = currentValue.tmpsTotal;
					dataDonut.labels.push(nomFam);
					dataDonut.datasets[0].data.push(tpsTotal);
				});
			}
			famDonut = new Chart(ctx, {
				type: 'doughnut',
				tooltipFillColor: "rgba(51, 51, 51, 0.55)",
				data: dataDonut
			});
		});


	}

	function fillLivDonut(){
		$("#livDonut").empty();
		var ctx = document.getElementById("livDonut");
		var livDonut;
		var dataDonut = {
			labels: [],
			datasets: [{
				data: [],
				backgroundColor: [
					"#3498DB",
					"#455C73",
					"#9B59B6",
					"#BDC3C7",
					"#26B99A"

				],
				hoverBackgroundColor: [

					"#CFD4D8",
					"#36CAAB",
					"#49A9EA",
					"#34495E",
					"#B370CF"
				]
			}]
		};

		$.getJSON("http://localhost/developement/queries/donnees_croisees.php?livTpsTotal=" + $("#selectProjectDC").val(), function(data){
			if (jQuery.parseJSON(data.data) !== false) {
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					var nomLiv = currentValue.liv;
					var tpsLivTotal = currentValue.tpsLivTotal;
					dataDonut.labels.push(nomLiv);
					dataDonut.datasets[0].data.push(tpsLivTotal);
				});
			}
			livDonut = new Chart(ctx, {
				type: 'doughnut',
				tooltipFillColor: "rgba(51, 51, 51, 0.55)",
				data: dataDonut
			});
		});


	}
	function fillResDonut(){
		$("#resDonut").empty();
		var ctx = document.getElementById("resDonut");
		var resDonut;
		var dataDonut = {
			labels: [],
			datasets: [{
				data: [],
				backgroundColor: [

					"#26B99A",
					"#3498DB",
					"#455C73",
					"#9B59B6",
					"#BDC3C7"
				],
				hoverBackgroundColor: [

					"#36CAAB",
					"#49A9EA",
					"#34495E",
					"#B370CF",
					"#CFD4D8"
				]
			}]
		};

		$.getJSON("http://localhost/developement/queries/donnees_croisees.php?resTpsTotal=" + $("#selectProjectDC").val(), function(data){
			if (jQuery.parseJSON(data.data) !== false) {
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					var nomRes = currentValue.ressource;
					var tpsResTotal = currentValue.tpsResTotal;
					dataDonut.labels.push(nomRes);
					dataDonut.datasets[0].data.push(tpsResTotal);
				});
			}
			resDonut = new Chart(ctx, {
				type: 'doughnut',
				tooltipFillColor: "rgba(51, 51, 51, 0.55)",
				data: dataDonut
			});
		});


	}
	function fillTacheDonut(){
		$("#tacheDonut").empty();
		var ctx = document.getElementById("tacheDonut");
		var tacheDonut;
		var dataDonut = {
			labels: [],
			datasets: [{
				data: [],
				backgroundColor: [

					"#26B99A",
					"#3498DB",
					"#455C73",
					"#9B59B6",
					"#BDC3C7"
				],
				hoverBackgroundColor: [

					"#36CAAB",
					"#49A9EA",
					"#34495E",
					"#B370CF",
					"#CFD4D8"
				]
			}]
		};

		$.getJSON("http://localhost/developement/queries/donnees_croisees.php?tpsTache=" + $("#selectProjectDC").val(), function(data){
			if (jQuery.parseJSON(data.data) !== false) {
				jQuery.parseJSON(data.data).forEach(function (currentValue) {
					var tache = currentValue.tache;
					var TpsTache = currentValue.TpsTache;
					dataDonut.labels.push(tache);
					dataDonut.datasets[0].data.push(TpsTache);
				});
			}
			tacheDonut = new Chart(ctx, {
				type: 'doughnut',
				tooltipFillColor: "rgba(51, 51, 51, 0.55)",
				data: dataDonut
			});
		});


	}

	function fillTpsResGraph(){

		$("#tpsResGraph").empty();
		var ctx = document.getElementById("tpsResGraph");
		var graphChart;
		var dataGraph = {
				labels: [],
				datasets: [{
				label: '',
				backgroundColor: "#26B99A",
				data: []
			}, {
				label: '',
				backgroundColor: "#03586A",
				data: []
			}]
		}

		$.getJSON("http://localhost/developement/queries/donnees_croisees.php?coutResMois=" + $("#selectProjectDC").val(), function(data){
			if (jQuery.parseJSON(data.data) !== false) {
				console.log(jQuery.parseJSON(data.data)[0]);
				console.log(jQuery.parseJSON(data.data)[1]);
				console.log(jQuery.parseJSON(data.data)[2]);

				for (i = 0; i<jQuery.parseJSON(data.data).length; i++){
					var alreadyExist = false;
					var nomRes = jQuery.parseJSON(data.data)[i]["nomRes"];
					var mois = jQuery.parseJSON(data.data)[i]["mois"];
					var prix = jQuery.parseJSON(data.data)[i]["prixConso"];

					if(dataGraph.labels.indexOf(mois) == -1) {
						dataGraph.labels.push(mois);
					}

					var posMois = dataGraph.labels.indexOf(mois);
					var posRes = i;

					for(var j = 0; j < dataGraph.datasets.length; j++) {

						if(dataGraph.datasets[j].label == nomRes) {
							posRes = j;
							break;
						}
					}
					dataGraph.datasets[posRes].label = nomRes;
					dataGraph.datasets[posRes].data.push(prix);
				};
			}
			console.info(dataGraph);
			graphChart = new Chart(ctx, {
				type: 'bar',
				data: dataGraph,

				options: {
					scales: {
						yAxes: [{
							ticks: {
								beginAtZero: true
							}
						}]
					}
				}
			});
		});
	};
</script>