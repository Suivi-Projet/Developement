<div class="row-fluid">
	<div class="span2 offset5">
		<h4>Projet :</h4>
		<select class="form-control" id="selectProjet" onChange="majAnnees();majTaches();majTableauTotal();"></select>
	</div>
</div>
<div class="row-fluid">
	<div class="span5 offset1">
		<fieldset>
			<legend>Zone de critères</legend>
			<table class="table table-bordered table-hover">
				<thead class="btn-primary disabled">
					<tr>
						<td>Mois</td>
						<td>Année</td>
						<td>Ressource</td>
						<td>Tâche</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>
							<select id="selectMois">
								<option value="0">Tous</option>
								<option value="1">Janvier</option>
								<option value="2">Février</option>
								<option value="3">Mars</option>
								<option value="4">Avril</option>
								<option value="5">Mai</option>
								<option value="6">Juin</option>
								<option value="7">Juillet</option>
								<option value="8">Août</option>
								<option value="9">Septembre</option>
								<option value="10">Octobre</option>
								<option value="11">Novembre</option>
								<option value="12">Décembre</option>
							</select>
						</td>
						<td>
							<select id="selectAnnee">
							</select>
						</td>
						<td>
							<select id="selectRessource" onChange="updateRessource();">
							</select>
						</td>
						<td>
							<select id="selectTache" onChange="updateTache();">
							</select>
						</td>
					</tr>
				</tbody>
			</table>
		</fieldset>
	</div>
	<div class="span5">
		<fieldset>
			<legend>Rapport totaux</legend>
			<table class="table table-bordered table-hover">
				<thead>
					<tr>
						<td></td>
						<td class="btn-primary disabled">temps (h)</td>
						<td class="btn-primary disabled">Montant (€)</td>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td class="btn-primary disabled">Totaux</td>
						<td id="tempsTotal"></td>
						<td id="montantTotal"></td>
					</tr>
				</tbody>
			</table>
		</fieldset>
	</div>
</div>
<script>
	function majProjets(){
		$("#selectProjet").empty();

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProjet").append("<option value='" + currentValue.codeProjet + "'>" + currentValue.libelleProjet + "</option>");
			});
			majTaches();
			majAnnees();
			majRessources();
		});
	}

	majProjets();

	function majAnnees(){
		$("#selectAnnee").empty();

		$.getJSON("http://localhost/Developement/queries/rapport_mensuel.php?anneesProjet=" + $("#selectProjet").val(), function(data){
			if(jQuery.parseJSON(data.data) !== false) {
				var numberOfYears = jQuery.parseJSON(data.data).bigAnnee - jQuery.parseJSON(data.data).smallAnnee;

				for (var i = 0; i < numberOfYears + 1; i++) {
					$("#selectAnnee").append("<option value=\"" + (jQuery.parseJSON(data.data).bigAnnee - i) + "\">" + (jQuery.parseJSON(data.data).bigAnnee - i) + "</option>");
				};
			}
		});
	}

	function majRessources(){
		$("#selectRessource").empty();

		$("#selectRessource").append("<option value=\"0\"> --- </option>");

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=ressources", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectRessource").append("<option value='" + currentValue.codeRessource + "'>" + currentValue.nomRessource + "</option>");
			});
		});
	}

	function majTaches(){
		$("#selectTache").empty();

		$("#selectTache").append("<option value=\"0\"> --- </option>");

		$.getJSON("http://localhost/Developement/queries/previsionnel.php?idProjet=" + $("#selectProjet").val(), function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectTache").append("<option value='" + currentValue.codeTache + "'>" + currentValue.referenceTache + "</option>");
			});
		});
	}

	function majTableauTotal(){
		$("#tempsTotal").empty();
		$("#montantTotal").empty();

		var url = "";

		if ($("#selectRessource").val() == "0") {
			url = "http://localhost/Developement/queries/rapport_mensuel.php?idTache=" + $("#selectTache").val() + "&idProjet=" + $("#selectProjet").val();
			$.getJSON(url, function(data){
				if(jQuery.parseJSON(data.total) !== false) {
					var tempsTotal = jQuery.parseJSON(data.total)[0].tempsTotal != null ? jQuery.parseJSON(data.total)[0].tempsTotal : 0;
					var montantTotal = jQuery.parseJSON(data.total)[0].montantTotal != null ? jQuery.parseJSON(data.total)[0].montantTotal : 0;
					$("#tempsTotal").append(tempsTotal);
					$("#montantTotal").append(montantTotal);
				}
			});
		} else if ($("#selectTache").val() == "0") {
			url = "http://localhost/Developement/queries/rapport_mensuel.php?idRessource=" + $("#selectRessource").val() + "&idProjet=" + $("#selectProjet").val();
			$.getJSON(url, function(data){
				if(jQuery.parseJSON(data.total) !== false) {
					var tempsTotal = jQuery.parseJSON(data.total)[0].tempsTotal != null ? jQuery.parseJSON(data.total)[0].tempsTotal : 0;
					var montantTotal = jQuery.parseJSON(data.total)[0].montantTotal != null ? jQuery.parseJSON(data.total)[0].montantTotal : 0;
					$("#tempsTotal").append(tempsTotal);
					$("#montantTotal").append(montantTotal);
				}
			});
		}
	}

	function updateRessource(){
		$("#selectTache").val("0");
		majTableauTotal();
	}

	function updateTache(){
		$("#selectRessource").val("0");
		majTableauTotal();
	}
</script>