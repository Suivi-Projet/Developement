<div class="row-fluid">
	<div class="span4">
		<h3>Projet :</h3>
		<select class="form-control" id="selectProject" onChange="majTaches()"></select>
	</div>
</div>
<div class="row-fluid">
	<div class="span11">
		<fieldset>
			<legend>Liste des tâches du projet</legend>
			<table class="table table-bordered table-hover">
				<thead class="btn-primary disabled">
					<tr>
						<td>Réf. Tâche</td>
						<td>Libellé</td>
						<td>Famille</td>
						<td>Début Prévu</td>
						<td>Fin Prévue</td>
						<td>Temps prévu en h</td>
						<td>Coût prévu €</td>
					</tr>
				</thead>
				<tbody id="taches">
				</tbody>
			</table>
		</fieldset>
	</div>
	<div class="span4">
		<button id="addTache">Ajouter une Tâche</button>
	</div>
</div>
<div id="dialog-form-tache" title="Ajouter une tache">
    <form class="form-horizontal">
		<div class="row-fluid">
			<div class="form-group">
				<div class="col-md-12">
					<label class="control-label col-md-3" for="nom">Intitulé</label>
					<div class=" col-md-3">
						<input class="form-control" type="text" id="nomTache">
					</div>
					<label class="control-label col-md-3" for="ref">Référence</label>
					<div class=" col-md-3">
						<input class="form-control" type="text" id="refTache">
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-md-12">
					<label class="control-label col-md-3" for="famille">Famille</label>
					<div class=" col-md-3">
						<select class="form-control" id="selectFamille"></select>
					</div>
					<label class="control-label col-md-3" for="livTache">Livrable</label>
					<div class=" col-md-3">
						<select class="form-control" id="selectLivrable"><option value="0"> --- </option></select>
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-md-12">
					<label class="control-label col-md-3" for="dateDebut">Date de début</label>
					<div class=" col-md-3">
						<input class="form-control" type="text" id="startTache" class="datePicker">
					</div>
					<label class="control-label col-md-3" for="dateFin">Date de fin</label>
					<div class=" col-md-3">
						<input class="form-control" type="text" id="endTache" class="datePicker">
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-md-12">
					<label class="control-label col-md-3" for="tpsTache">Temps prévu</label>
					<div class=" col-md-3">
						<input class="form-control" type="number" id="tempsTache">
					</div>
					<label class="control-label col-md-3" for="ctTache">Coût prévu</label>
					<div class=" col-md-3">
						<input class="form-control" type="number" id="coutTache">
					</div>
				</div>
			</div>
		</div>
    </form>
</div>
<script>
	$(function() {
        var dialogTache, formTache,

		nomTache = $( "#nomTache" ),
        refTache = $("#refTache"),
        dateDebut = $("#startTache"),
        dateFin = $("#endTache"),
        tpsPrevu = $("#tempsTache"),
        ctPrevu = $("#coutTache"),
        allFields = $( [] ).add(nomTache).add(refTache).add(dateDebut).add(dateFin).add(tpsPrevu).add(ctPrevu),
        tips = $( ".validateTips" );

        function updateTips( t ) {
            tips
				.text( t )
				.addClass( "ui-state-highlight" );
            setTimeout(function() {
                tips.removeClass( "ui-state-highlight", 1500 );
            }, 500 );
        }

        function checkLength( o, n, min, max ) {
            if ( o.val().length > max || o.val().length < min ) {
                o.addClass( "ui-state-error" );
                updateTips( "Length of " + n + " must be between " +
                        min + " and " + max + "." );
                return false;
            } else {
                return true;
            }
        }

        function addTache() {
            var valid = true;
            allFields.removeClass( "ui-state-error" );

            valid = valid && checkLength( nomTache, "nomtache", 3, 255 ) && checkLength(refTache, "reftache", 2, 8) && checkLength(dateDebut, "dateDebut", 10, 10) && checkLength(dateFin, "dateFin", 10, 10) && checkLength(tpsPrevu, "tempsPrevu", 1, 10) && checkLength(ctPrevu, "coutPrevu", 1, 10);

            if ( valid ) {
            	var codeLivrable = $("#selectLivrable").val() == "0" ? null : "\"" + $("#selectLivrable").val() + "\"";
				$.ajax({
					type: "POST",
					url: "http://localhost/Developement/queries/parametres.php",
					dataType: 'json',
					contentType:'application/json',
					data: '{"objet" : "tache",	"libelleTache" : "'+$("#nomTache").val()+'","refTache" : "'+$("#refTache").val()+'","codeFamille" : "'+$("#selectFamille").val()+'","dateDebutPrevue" : "'+new Date($("#startTache").val()).getFullYear() + "-" + (new Date($("#startTache").val()).getMonth() + 1) + "-" + new Date($("#startTache").val()).getDate() +'","dateFinPrevue" : "'+new Date($("#endTache").val()).getFullYear() + "-" + (new Date($("#endTache").val()).getMonth() + 1) + "-" + new Date($("#endTache").val()).getDate()+'", "codeProjet" : "'+$("#selectProject").val()+'","tempsPrevu" : "' + $("#tempsTache").val() + '", "coutPrevu" : "' + $("#coutTache").val() + '", "codeLivrable" : ' + codeLivrable + ' }',
					success : function(){
						majProjects();
						dialogTache.dialog("close");
					},
					error : function(){
						alert("Y'a un souci")
						dialogTache.dialog("close");
					}
				});
            }
            return valid;
        }

        dialogTache = $( "#dialog-form-tache" ).dialog({
            autoOpen: false,
            height: 350,
            width: 795,
            modal: true,
            buttons: {
                "Ajouter": addTache,
                Cancel: function() {
                    dialogTache.dialog( "close" );
                }
            },
            close: function() {
                formTache[ 0 ].reset();
                allFields.removeClass( "ui-state-error" );
            }
        });

        formTache = dialogTache.find( "form" ).on( "submit", function( event ) {
            event.preventDefault();
            addTache();
        });

        $( "#addTache" ).button().on( "click", function() {
            dialogTache.dialog( "open" );
        });
    });
</script>
<script>
	function majProjects() {
		var selected = $("#selectProject").val();

		$("#selectProject").empty();

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProject").append("<option value=\"" + currentValue.codeProjet + "\">" + currentValue.libelleProjet + "</option>");
			});
			$("#selectProject").val(selected);
			majTaches();
		});
	}

	function majTaches(){

		var months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

		$("#taches").empty();

		$.getJSON("http://localhost/Developement/queries/previsionnel.php?idProjet=" + $("#selectProject").val(), function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				var dateDebut = new Date(currentValue.dateDebutPrevue).getDate() + " " + months[new Date(currentValue.dateDebutPrevue).getMonth()] + " " + new Date(currentValue.dateDebutPrevue).getFullYear();
				var dateFin = new Date(currentValue.dateFinPrevue).getDate() + " " + months[new Date(currentValue.dateFinPrevue).getMonth()] + " " + new Date(currentValue.dateFinPrevue).getFullYear();
				$("#taches").append("<tr><td>" + currentValue.referenceTache + "</td><td>" + currentValue.libelleTache + "</td><td>" + currentValue.libelleFamille + "</td><td>" + dateDebut + "</td><td>" + dateFin + "</td><td>"+ currentValue.tempsPrevu +"</td><td>"+ currentValue.coutPrevu +"</td></tr>");
			});
		});
	}

	$.getJSON("http://localhost/Developement/queries/parametres.php?objet=familles", function(data){
		if(jQuery.parseJSON(data.data) !== false)
		jQuery.parseJSON(data.data).forEach(function (currentValue) {
			$("#selectFamille").append("<option value=\"" + currentValue.codeFamille + "\">" + currentValue.libelleFamille + "</option>");
		});
	});

	$.getJSON("http://localhost/Developement/queries/parametres.php?objet=livrables", function(data){
		if(jQuery.parseJSON(data.data) !== false)
		jQuery.parseJSON(data.data).forEach(function (currentValue) {
			$("#selectLivrable").append("<option value=\"" + currentValue.codeLivrable + "\">" + currentValue.libelleLivrable + "</option>");
		});
	});


    $( ".datePicker" ).datepicker();

    function razProjects() {
		$("#selectProject").empty();

		$.getJSON("http://localhost/Developement/queries/parametres.php?objet=projets", function(data){
			if(jQuery.parseJSON(data.data) !== false)
			jQuery.parseJSON(data.data).forEach(function (currentValue) {
				$("#selectProject").append("<option value=\"" + currentValue.codeProjet + "\">" + currentValue.libelleProjet + "</option>");
			});
			majTaches();
		});
    }

	razProjects();
</script>